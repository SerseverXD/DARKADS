<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dark Admin Ad Manager</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <style>
    /* --- DARK PROFILE THEME ðŸŒ‘ --- */
    :root {
      --bg: #121212; /* Dark Background */
      --primary: #bb86fc; /* Purple accent */
      --secondary: #03dac6; /* Teal accent */
      --text: #e0e0e0; /* Light text */
      --muted: #999999;
      --card-bg: #1e1e1e; /* Darker card background */
      --radius: 18px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      --red-delete: #cf6679; /* Dark mode red */
      --input-bg: #2c2c2c;
      --input-border: #3d3d3d;
      --blur: none; /* No blur in dark mode */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #app-container {
        width: 100%;
        max-width: 450px; 
        margin: auto;
        padding-bottom: 20px;
    }

    /* --- General Styles --- */
    h1 {
        text-align: center;
        color: var(--primary);
        font-size: 2rem;
        margin-bottom: 2rem;
    }
    
    header {
        text-align: center;
        font-size: 1.5rem;
        font-weight: 600;
        padding: 1rem;
        color: var(--secondary);
    }

    section {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--input-border);
    }
    
    .hidden { display: none !important; }

    /* --- Form & Input Styles --- */
    form {
      display: flex; flex-direction: column; gap: 1rem;
    }
    
    /* Input Group for Type Selection */
    .input-group label {
        display: block;
        color: var(--muted);
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .ad-type-selector {
        display: flex;
        gap: 10px;
    }
    
    .ad-type-selector input[type="radio"] {
        display: none;
    }
    
    .ad-type-selector label {
        flex-grow: 1;
        text-align: center;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
        cursor: pointer;
        background: var(--input-bg);
        transition: 0.2s;
        font-weight: 500;
        color: var(--muted);
        margin-bottom: 0;
    }
    
    .ad-type-selector input[type="radio"]:checked + label {
        background: var(--primary);
        color: var(--card-bg);
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.2);
    }

    input, textarea {
      padding: 0.8rem; border-radius: 12px; border: 1px solid var(--input-border);
      font-size: 1rem; font-family: 'Poppins', sans-serif; width: 100%;
      background: var(--input-bg); color: var(--text);
    }
    
    input:focus, textarea:focus {
        border-color: var(--primary); box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.2); outline: none;
    }

    button {
      border: none;
      border-radius: var(--radius);
      padding: 0.8rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      background: var(--primary);
      color: var(--card-bg);
      transition: 0.2s;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }

    button:active { transform: scale(0.98); }
    .btn-delete { background: var(--red-delete); color: var(--card-bg); }

    /* --- Ad List Styles --- */
    #adsList { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
    
    .ad-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--input-bg);
        padding: 10px 15px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
    }
    
    .ad-info { flex-grow: 1; min-width: 0; }
    .ad-info h4 { margin: 0; font-size: 1rem; color: var(--secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ad-info small { display: block; color: var(--muted); font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .ad-type-badge {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 5px;
        margin-right: 8px;
        color: var(--card-bg);
        background-color: var(--secondary);
    }
    .ad-type-badge.image { background-color: var(--primary); }

    .ad-actions { flex-shrink: 0; margin-left: 10px; }
    .ad-actions button { padding: 5px 10px; font-size: 0.8rem; border-radius: 8px; }

  </style>
</head>
<body>
<div id="app-container">
    <header><i class="fa-solid fa-moon"></i> Dark Admin Ad Manager</header>
    
    <section id="loginSection">
        <h2 style="text-align: center; color: var(--primary); margin-top: 0;">Admin Login</h2>
        <form id="loginForm">
            <input type="password" id="masterKeyInput" placeholder="Enter Admin Master Key" required />
            <button type="submit"><i class="fa-solid fa-lock"></i> Login</button>
            <p id="loginMessage" style="color: var(--red-delete); text-align: center; margin-top: 1rem;" class="hidden"></p>
        </form>
    </section>

    <section id="adManagerSection" class="hidden">
        <h2 style="color: var(--secondary); margin-top: 0;">Create New Ad</h2>
        <form id="createAdForm">
            
            <div class="input-group">
                <label>Ad Type</label>
                <div class="ad-type-selector">
                    <input type="radio" id="typeText" name="adType" value="text" checked>
                    <label for="typeText"><i class="fa-solid fa-font"></i> Text Ad</label>
                    <input type="radio" id="typeImage" name="adType" value="image">
                    <label for="typeImage"><i class="fa-solid fa-image"></i> Image Ad</label>
                </div>
            </div>

            <input type="text" id="adTitle" placeholder="Ad Title (e.g., Check out the New Blog!)" required />
            <input type="url" id="adLink" placeholder="Destination URL (e.g., https://google.com)" required />
            
            <div id="textFields">
                <textarea id="adDescription" placeholder="Short Ad Description (for sticky/native banner)" required></textarea>
            </div>

            <div id="imageFields" class="hidden">
                <input type="url" id="imageUrl" placeholder="Image URL (Blocco, e.g., https://example.com/block.png)" required/>
                <input type="url" id="bannerImageUrl" placeholder="Image URL (Banner, e.g., https://example.com/banner.png)" style="margin-top: 1rem;" required/>
                
                <textarea id="imageAdDescription" placeholder="Short description for Image Ad (Optional)" style="margin-top: 1rem;"></textarea>
                <p style="color: var(--muted); font-size: 0.8rem; margin: 0.5rem 0 0 0;">Fornire l'URL per l'immagine Blocco e l'immagine Banner. L'immagine verrÃ  classificata per dimensione (Banner/Blocco) sul blog.</p>
            </div>
            
            <button type="submit"><i class="fa-solid fa-plus-circle"></i> Create Ad</button>
        </form>

        <h2 style="color: var(--secondary); margin-top: 2rem; border-top: 1px solid var(--input-border); padding-top: 2rem;">Existing Ads</h2>
        <div id="adsList">
            <div style="text-align: center; color: var(--muted);" id="loadingIndicator"><i class="fa-solid fa-spinner fa-spin"></i> Loading Ads...</div>
        </div>
    </section>

</div>

  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURATION ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    const userProvidedConfig = {
        // !!! MUST MATCH YOUR MAIN BLOG'S CONFIG !!!
        apiKey: "AIzaSyBiDjwSktDSEdomaRnbfl1UcvCgihhWH1A", 
        projectId: "themoreinfoblog",
    };
    const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const firebaseConfig = { ...userProvidedConfig, ...canvasConfig };

    // !!! MUST MATCH YOUR MAIN BLOG'S ADMIN KEY !!!
    const ADMIN_PASSKEY = "9VJZxFKQhqkDrZXerdFfryKdwZ9AMrr5"; 

    // --- Firestore Paths ---
    // !!! MUST MATCH YOUR MAIN BLOG'S ADS PATH !!!
    const ADS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ads`; 

    let db;
    let isAdminLoggedIn = false;
    let adsUnsubscribe = null;

    // --- DOM Elements ---
    const loginSection = document.getElementById('loginSection');
    const adManagerSection = document.getElementById('adManagerSection');
    const loginForm = document.getElementById('loginForm');
    const masterKeyInput = document.getElementById('masterKeyInput');
    const loginMessage = document.getElementById('loginMessage');
    const createAdForm = document.getElementById('createAdForm');
    const adsList = document.getElementById('adsList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // Conditional fields
    const adTypeRadios = document.querySelectorAll('input[name="adType"]');
    const textFields = document.getElementById('textFields');
    const imageFields = document.getElementById('imageFields');
    const adDescriptionInput = document.getElementById('adDescription');
    const imageUrlInput = document.getElementById('imageUrl');
    // ðŸ’¡ NUOVO RIFERIMENTO AL CAMPO BANNER
    const bannerImageUrlInput = document.getElementById('bannerImageUrl');
    const imageAdDescriptionInput = document.getElementById('imageAdDescription');


    // --- Helper Functions ---

    /**
     * Simula il controllo delle dimensioni dell'immagine per la classificazione.
     * Dato che ora abbiamo un URL per Blocco e uno per Banner, 
     * questa funzione (o la sua logica) Ã¨ puramente un placeholder 
     * per mantenere la coerenza con il messaggio HTML/precedente logica.
     * Nel manager inviamo sempre 'N/A' o una classificazione fissa per 
     * evitare un controllo asincrono non necessario qui.
     */
    function checkImageDimensions(url) {
        // Logica di classificazione semplificata o fittizia per il manager.
        // Risolveremo sempre 'block' per mostrare che Ã¨ un ad "immagine".
        return Promise.resolve('block/banner'); 
    }

    function toggleFormFields() {
        const selectedType = document.querySelector('input[name="adType"]:checked').value;
        
        if (selectedType === 'text') {
            textFields.classList.remove('hidden');
            imageFields.classList.add('hidden');
            // Campi testo: descrizione obbligatoria
            adDescriptionInput.setAttribute('required', 'required');
            // Campi immagine: non obbligatori
            imageUrlInput.removeAttribute('required');
            bannerImageUrlInput.removeAttribute('required'); // NUOVO CAMPO
            imageAdDescriptionInput.removeAttribute('required'); 
        } else {
            textFields.classList.add('hidden');
            imageFields.classList.remove('hidden');
            // Campi testo: non obbligatori
            adDescriptionInput.removeAttribute('required');
            // Campi immagine: URL Blocco e Banner obbligatori
            imageUrlInput.setAttribute('required', 'required');
            bannerImageUrlInput.setAttribute('required', 'required'); // NUOVO CAMPO
            imageAdDescriptionInput.removeAttribute('required'); 
        }
    }


    // --- Firebase Functions ---
    async function initFirebase() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) { 
            console.error("Error initializing Firebase:", error); 
            alert("Firebase Initialization Failed! Check console for details.");
        }
    }

    function startAdsListener() {
        if (!db) return;
        if (adsUnsubscribe) adsUnsubscribe(); // Stop any existing listener

        const adsCollectionRef = collection(db, ADS_COLLECTION_PATH);
        
        adsUnsubscribe = onSnapshot(adsCollectionRef, (snapshot) => {
            const allAds = [];
            snapshot.forEach(doc => {
                allAds.push({ id: doc.id, ...doc.data() }); 
            });
            renderAdsList(allAds);
        }, (error) => {
             console.error("Error listening to ads:", error);
             renderAdsList([]); // Render empty list on error
        });
    }

    function renderAdsList(ads) {
        adsList.innerHTML = ''; // Clear existing list
        if (ads.length === 0) {
            adsList.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 10px;">No ads created yet.</div>';
            return;
        }

        ads.forEach(ad => {
            const isImageAd = ad.type === 'image';
            const badgeClass = isImageAd ? 'image' : 'text';
            const typeLabel = isImageAd ? 'IMG' : 'TXT';

            let detailLabel = '';
            let adDetail = '';

            if (ad.description && ad.description.trim() !== '') {
                // PrioritÃ  1: Mostra la descrizione
                detailLabel = 'Description';
                adDetail = ad.description;
            } else if (isImageAd && ad.bannerImageUrl) {
                // PrioritÃ  2 (Immagine senza descrizione): Mostra l'URL Banner
                 detailLabel = 'Banner URL';
                adDetail = ad.bannerImageUrl;
            } else {
                 // PrioritÃ  3: Mostra il link generale o N/A
                detailLabel = 'Link';
                adDetail = ad.link || 'N/A';
            }

            const displayDetail = adDetail ? (adDetail.length > 50 ? adDetail.substring(0, 50) + '...' : adDetail) : 'N/A';


            const adDiv = document.createElement('div');
            adDiv.className = 'ad-item';
            adDiv.innerHTML = `
                <div class="ad-info">
                    <h4><span class="ad-type-badge ${badgeClass}">${typeLabel}</span>${ad.title || 'No Title'}</h4>
                    <small>${detailLabel}: ${displayDetail}</small>
                </div>
                <div class="ad-actions">
                    <button class="btn-delete" data-id="${ad.id}"><i class="fa-solid fa-trash-alt"></i> Delete</button>
                </div>
            `;
            adDiv.querySelector('.btn-delete').addEventListener('click', () => deleteAd(ad.id));
            adsList.appendChild(adDiv);
        });
    }

    async function deleteAd(adId) {
        if (!confirm("Are you sure you want to delete this ad?")) return;
        try {
            await deleteDoc(doc(db, ADS_COLLECTION_PATH, adId));
            alert("Ad deleted successfully!");
        } catch (error) {
            console.error("Error deleting ad:", error);
            alert("Failed to delete ad.");
        }
    }

    // --- Event Handlers ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const key = masterKeyInput.value.trim();
        loginMessage.classList.add('hidden');
        
        if (key === ADMIN_PASSKEY) {
            isAdminLoggedIn = true;
            loginSection.classList.add('hidden');
            adManagerSection.classList.remove('hidden');
            startAdsListener();
            toggleFormFields(); // Initialize fields visibility
        } else {
            loginMessage.textContent = "Invalid Master Key.";
            loginMessage.classList.remove('hidden');
            masterKeyInput.value = '';
        }
    });
    
    adTypeRadios.forEach(radio => radio.addEventListener('change', toggleFormFields));

    createAdForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAdminLoggedIn) return;
        
        const title = document.getElementById('adTitle').value.trim();
        const link = document.getElementById('adLink').value.trim();
        const type = document.querySelector('input[name="adType"]:checked').value;
        
        if (!title || !link) {
            alert("Title and Link are required!");
            return;
        }
        
        let adData = {
            title: title,
            link: link,
            type: type,
            createdAt: new Date().toISOString()
        };

        if (type === 'text') {
            const description = adDescriptionInput.value.trim();
            if (!description) {
                alert("Description is required for Text Ads!");
                return;
            }
            adData.description = description;
            adData.imageSize = 'N/A'; // Non applicabile
        } else { // type === 'image'
            const imageUrl = imageUrlInput.value.trim();
            const bannerImageUrl = bannerImageUrlInput.value.trim(); // NUOVO CAMPO
            const imageDesc = imageAdDescriptionInput.value.trim();

            if (!imageUrl || !bannerImageUrl) { // VALIDAZIONE AGGIORNATA
                alert("Both Block Image URL and Banner Image URL are required for Image Ads!");
                return;
            }
            
            adData.imageUrl = imageUrl; // URL per annuncio Blocco
            adData.bannerImageUrl = bannerImageUrl; // URL per annuncio Banner (NUOVO)
            adData.description = imageDesc; // Descrizione (opzionale)
            
            // Classificazione simulata: salva il risultato in Firestore
            adData.imageSize = await checkImageDimensions(imageUrl);
        }

        try {
            await addDoc(collection(db, ADS_COLLECTION_PATH), adData);
            createAdForm.reset();
            toggleFormFields(); // Reset form fields visibility
            alert("Ad created successfully!");
        } catch (error) {
            console.error("Error creating ad:", error);
            alert("Failed to create ad.");
        }
    });

    // --- Initialization ---
    initFirebase();
    // Tenta di inizializzare lo stato della UI se non loggato.
    document.addEventListener('DOMContentLoaded', () => {
        if (!isAdminLoggedIn) {
            toggleFormFields(); 
            // Assicura che i campi immagine siano nascosti di default se il radio 'text' Ã¨ checked
            if (document.getElementById('typeText').checked) {
                imageFields.classList.add('hidden');
                textFields.classList.remove('hidden');
            }
        }
    });
  </script>
</body>
</html>
